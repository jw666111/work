# ALB 丰富转发规则 - 产品需求文档

## 文档信息

| 项目 | 说明 |
|------|------|
| 文档版本 | v1.0 |
| 产品模块 | 应用负载均衡器 (ALB) |
| 需求类型 | 功能增强 |

---

## 1. 背景与目标

### 1.1 背景

完善产品功能，增加产品竞争力。当前 UCloud ALB 在转发规则方面的能力相比阿里云、AWS 存在差距，需要丰富转发规则的条件和动作类型。

### 1.2 需求目标

- ✅ 支持用户转发规则自定义优先级
- ✅ 丰富转发规则匹配条件
- ✅ 支持响应方向匹配条件
- ✅ 明确配额限制策略

---

## 2. 竞品功能对比

### 2.1 请求方向 - 条件对比

| 条件类型 | UCloud (现状) | 阿里云 | AWS | 本期是否支持 |
|---------|--------------|--------|-----|-------------|
| 域名 | ✅ 正则、泛解析 | ✅ | ✅ | ✅ |
| 路径 | ✅ 正则 | ✅ | ✅ | ✅ |
| HTTP 标头 | ❌ | ✅ | ✅ | ✅ |
| HTTP 请求方法 | ❌ | ✅ | ✅ | ✅ |
| 源 IP | ❌ | ✅ | ✅ | ✅ |
| 查询字符串 | ❌ | ✅ | ✅ | ✅ |
| Cookie | ❌ | ✅ | ❌ | ✅ |

### 2.2 请求方向 - 动作对比

| 动作类型 | UCloud (现状) | 阿里云 | AWS | 本期是否支持 |
|---------|--------------|--------|-----|-------------|
| 写入 Header | ✅ | ✅ | ❌ | ✅ |
| 删除 Header | ✅ | ✅ | ❌ | ✅ |
| 跨域配置 | ✅ | ✅ | ❌ | ✅ |
| 关闭缓存 | ✅ | ✅ | ❌ | ✅ |
| 转发至 | ✅ | ✅ | ✅ | ✅ |
| 固定响应 | ✅ | ✅ | ✅ | ✅ |
| 重定向至 | ✅ | ✅ | ✅ | ✅ |
| 重写 | ❌ | ✅ | ❌ | ⏸️ 暂不支持 |
| 限速 | ❌ | ✅ | ❌ | ⏸️ 暂不支持 |
| 流量镜像至 | ❌ | ✅ | ❌ | ⏸️ 暂不支持 |
| 身份验证 | ❌ | ❌ | ✅ | ⏸️ 暂不支持 |

### 2.3 响应方向 - 条件对比

| 条件类型 | UCloud (现状) | 阿里云 | AWS | 本期是否支持 |
|---------|--------------|--------|-----|-------------|
| **请求方向条件** |||||
| 域名 | ❌ | ✅ | ❌ | ✅ |
| 路径 | ❌ | ✅ | ❌ | ✅ |
| HTTP 标头 | ❌ | ✅ | ❌ | ✅ |
| 查询字符串 | ❌ | ✅ | ❌ | ✅ |
| HTTP 请求方法 | ❌ | ✅ | ❌ | ✅ |
| Cookie | ❌ | ✅ | ❌ | ✅ |
| 源 IP | ❌ | ✅ | ❌ | ✅ |
| **响应方向条件** |||||
| 响应状态码 | ❌ | ✅ | ❌ | ✅ |
| 响应标头 | ❌ | ✅ | ❌ | ✅ |

### 2.4 响应方向 - 动作对比

| 动作类型 | UCloud (现状) | 阿里云 | AWS | 本期是否支持 |
|---------|--------------|--------|-----|-------------|
| 写入 Header | ✅ | ✅ | ❌ | ✅ |
| 删除 Header | ❌ | ✅ | ❌ | ✅ |
| 返回固定响应 | ❌ | ✅ | ❌ | ⏸️ 暂不支持 |

---

## 3. 功能架构

### 3.1 整体流程

```
┌──────────┐      请求方向转发规则        ┌──────────────┐
│  客户端   │ ─────────────────────────▶ │  后端服务器    │
│          │                            │              │
│          │ ◀───────────────────────── │              │
└──────────┘      响应方向转发规则        └──────────────┘
                      │
                      ▼
              ┌───────────────┐
              │     ALB       │
              │  ┌─────────┐  │
              │  │请求方向  │  │
              │  │转发规则  │  │
              │  ├─────────┤  │
              │  │响应方向  │  │
              │  │转发规则  │  │
              │  └─────────┘  │
              └───────────────┘
```

### 3.2 规则处理逻辑

| 规则类型 | 条件设置 | 动作设置 |
|---------|---------|---------|
| 请求方向转发规则 | 仅支持请求方向条件 | 请求方向动作 |
| 响应方向转发规则 | 请求方向条件（选填）+ 响应方向条件（必填） | 响应方向动作 |

---

## 4. 功能详细设计

### 4.1 请求方向转发规则

#### 4.1.1 规则配置项

| 配置项 | 是否必填 | 说明 |
|-------|---------|------|
| 优先级 | ✅ 必填 | 1-10000，数值越小优先级越高，同一监听器内不可重复 |
| 转发条件 | ✅ 必填 | 单条规则最多配置 10 个条件 |
| 转发动作 | ✅ 必填 | 单条规则最多配置 5 个动作 |
| 备注 | 选填 | 规则描述信息 |

#### 4.1.2 请求方向条件详细说明

| 条件类型 | 功能说明 | 配置要求 | 约束限制 |
|---------|---------|---------|---------|
| **域名** | 匹配请求的 Host 头 | 输入域名，支持正则、泛解析 | 同一规则内不支持重复 |
| **路径** | 匹配请求 URL 路径 | 输入路径，支持正则 | 同一规则内不支持重复 |
| **HTTP 标头** | 匹配请求 Header 的键值对 | 键：HTTP 标头名称<br>值：HTTP 标头内容（支持多条） | - 支持通配符<br>- 键：1~40 字符，仅允许大小写英文字母、数字、下划线（_）和中划线（-）<br>- 值：1~128 字符 |
| **查询字符串** | 匹配请求 URL 中的查询参数 | 添加一个或多个查询字符串的键值对 | - 键：1~100 字符<br>- 值：1~128 字符<br>- 不区分大小写<br>- 支持通配符 `*` 和 `?`<br>- 不支持空格和 `#[]{}\|<>&` 等特殊字符 |
| **请求方法** | 匹配 HTTP 方法 | 选择 HTTP 请求方法 | - 支持多值匹配（或关系）<br>- 可选值：HEAD、GET、POST、OPTIONS、PUT、PATCH、DELETE<br>- 同一规则内不支持重复 |
| **Cookie** | 匹配请求中的 Cookie 键值对 | 添加一个或多个 Cookie 键值对 | - 键：1~100 字符<br>- 值：1~128 字符<br>- 不区分大小写<br>- 支持通配符 `*` 和 `?`<br>- 不支持空格和 `[]{}<>\#\|&` 等特殊字符 |
| **源 IP** | 匹配请求的源 IP 地址 | 添加一个或多个 IP 地址或 IP 地址段 | 支持 CIDR 格式 IP 段 |

---

### 4.2 响应方向转发规则

#### 4.2.1 规则配置项

| 配置项 | 是否必填 | 说明 |
|-------|---------|------|
| 优先级 | ✅ 必填 | 1-10000，数值越小优先级越高，同一监听器内不可重复 |
| 请求方向条件 | 选填 | 用于筛选特定请求的响应 |
| 响应方向条件 | ✅ 必填 | 匹配后端返回的响应特征 |
| 转发动作 | ✅ 必填 | 响应方向动作 |
| 备注 | 选填 | 规则描述信息 |

#### 4.2.2 请求方向条件（选填）

> 用于筛选需要处理响应的特定请求

| 条件类型 | 功能说明 | 配置要求 | 约束限制 |
|---------|---------|---------|---------|
| **HTTP 标头** | 匹配请求 Header 的键值对 | 键：HTTP 标头名称<br>值：HTTP 标头内容 | - 支持通配符<br>- 键：1~40 字符<br>- 值：1~128 字符 |
| **查询字符串** | 匹配请求 URL 中的查询参数 | 添加一个或多个键值对 | - 键：1~100 字符<br>- 值：1~128 字符 |
| **请求方法** | 匹配 HTTP 方法 | 选择 HTTP 请求方法 | 支持多值匹配（或关系） |
| **Cookie** | 匹配请求中的 Cookie 键值对 | 添加一个或多个 Cookie | 键/值长度及字符限制同上 |
| **源 IP** | 匹配请求的源 IP 地址 | IP 地址或 IP 地址段 | 支持 CIDR 格式 |

#### 4.2.3 响应方向条件（必填）

| 条件类型 | 功能说明 | 配置要求 | 约束限制 |
|---------|---------|---------|---------|
| **响应状态码** | 匹配后端返回给 ALB 的状态码 | 输入状态码或状态码范围 | - 取值范围：100~599<br>- 支持范围格式，多个用逗号分隔<br>- 示例：`200-233,300-399,404` |
| **响应标头** | 匹配后端返回的 HTTP 标头 | 键：HTTP 标头名称<br>值：HTTP 标头内容 | - 键/值长度限制同请求方向条件 |

#### 4.2.4 响应方向动作

| 动作类型 | 功能说明 | 配置要求 |
|---------|---------|---------|
| **写入 Header** | 向响应中添加或覆盖 HTTP 标头 | 配置键值对 |
| **删除 Header** | 删除响应中的指定 HTTP 标头 | 配置标头名称 |
| **返回固定响应** | 拦截并修改后端响应，返回固定内容 | - 响应状态码：2xx、4xx、5xx<br>- 响应正文类型（选填）<br>- 响应正文（选填） |

---

## 5. 优先级与匹配策略

### 5.1 优先级规则

| 规则 | 说明 |
|------|------|
| 优先级范围 | 1-10000 |
| 优先级含义 | 数值越小，优先级越高 |
| 唯一性约束 | 同一监听器内的转发规则优先级不可重复 |
| 配置方式 | 用户创建规则时自定义输入 |

### 5.2 匹配策略

#### 请求方向匹配流程

```
客户端请求 ──▶ 按优先级逐条匹配规则 ──▶ 匹配成功 ──▶ 执行对应动作
                      │
                      ▼ 未匹配到任何规则
                默认转发规则处理
```

#### 响应方向匹配流程

```
后端响应 ──▶ 按优先级逐条匹配规则 ──▶ 匹配成功 ──▶ 执行对应动作
                    │
                    ▼ 未匹配到任何规则
              直接返回原始响应给客户端
```

### 5.3 条件匹配逻辑

| 场景 | 逻辑关系 | 说明 |
|------|---------|------|
| 同一规则的多个条件 | **且（AND）** | 需全部满足才能触发规则 |
| 同一条件的多个值 | **或（OR）** | 任意一个值匹配即可 |

**示例：**

```yaml
规则配置:
  条件1-域名: [dev.example.com, prod.example.com]  # 任一匹配即可（OR）
  条件2-路径: [/api/*]

匹配逻辑: (域名匹配 dev.example.com OR prod.example.com) AND (路径匹配 /api/*)
```

---

## 6. 配额限制

| 配额项 | 限制值 | 说明 |
|-------|-------|------|
| 单条规则最大条件数 | 10 | - |
| 单条规则最大动作数 | 5 | - |
| 单监听器最大转发规则数 | 待定 | 需确认 |
| 单实例最大转发规则数 | 待定 | 需确认 |
| 默认转发规则 | 不占用配额 | 系统自动创建 |

---

## 7. 兼容性与影响范围

### 7.1 历史数据兼容性

| 场景 | 处理方案 | 说明 |
|------|---------|------|
| 历史实例/规则对新功能的支持 | 待确认 | 需明确历史规则是否支持新增的条件类型和优先级配置 |
| 历史响应方向动作迁移 | 待确认 | 需明确现有响应方向动作的调整和迁移策略 |

### 7.2 待确认问题

- [ ] 历史创建的资源是否支持调整优先级？
- [ ] 历史规则是否自动支持新的条件类型？
- [ ] 响应方向动作的历史数据如何迁移？

---

## 8. 界面设计说明

### 8.1 入口位置

监听器详情页 → 内容转发 → 新增「请求方向」与「响应方向」转发规则配置 Tab

### 8.2 交互流程

```
监听器详情页
    │
    ├── 请求方向转发规则列表
    │       ├── 新建规则
    │       ├── 编辑规则
    │       ├── 删除规则
    │       └── 调整优先级
    │
    └── 响应方向转发规则列表
            ├── 新建规则
            ├── 编辑规则
            ├── 删除规则
            └── 调整优先级
```

---

## 9. 本期不支持功能（后续迭代）

| 功能 | 类型 | 竞品支持情况 |
|------|------|-------------|
| 重写（域名、路径、查询字符串） | 请求方向动作 | 阿里云 ✅ |
| 限速 | 请求方向动作 | 阿里云 ✅ |
| 流量镜像至 | 请求方向动作 | 阿里云 ✅ |
| 身份验证 | 请求方向动作 | AWS ✅ |
| 返回固定响应 | 响应方向动作 | 阿里云 ✅ |

---

## 附录

### A. 术语说明

| 术语 | 说明 |
|------|------|
| ALB | 应用负载均衡器（Application Load Balancer） |
| 转发规则 | 定义请求/响应如何被处理和路由的规则集 |
| 请求方向 | 客户端到后端服务器的流量方向 |
| 响应方向 | 后端服务器到客户端的流量方向 |
| 默认转发规则 | 当请求未匹配任何自定义规则时的兜底规则 |

### B. 参考文档

- 阿里云 ALB 转发规则文档
- AWS ALB 转发规则文档
